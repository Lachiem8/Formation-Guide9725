<script>
  const predefinedFormations = {
    9: [5, 4], 10: [5, 5], 11: [6, 5], 12: [6, 6], 13: [5, 4, 4],
    14: [5, 4, 5], 15: [6, 5, 4], 16: [6, 5, 5], 17: [6, 5, 6],
    18: [7, 6, 5], 19: [7, 6, 6], 20: [7, 6, 7], 21: [7, 5, 5, 4],
    22: [7, 6, 5, 4], 23: [7, 6, 5, 5], 24: [7, 6, 5, 6],
    25: [7, 6, 6, 6], 26: [7, 6, 6, 7], 27: [7, 6, 7, 7],
    28: [8, 7, 6, 7], 29: [8, 7, 7, 7], 30: [8, 7, 8, 7],
    31: [8, 7, 8, 8], 32: [9, 8, 7, 8], 33: [9, 8, 8, 8],
    34: [9, 8, 9, 8], 35: [9, 9, 9, 8], 36: [10, 9, 8, 9],
    37: [10, 9, 9, 9], 38: [10, 9, 10, 9], 39: [10, 9, 8, 7, 7],
    40: [10, 9, 8, 8, 8], 41: [9, 8, 7, 8, 9], 42: [10, 9, 8, 7, 8],
    43: [10, 9, 8, 8, 8], 44: [10, 9, 8, 9, 8]
  };

  function getRowCount(count) {
    if (count >= 172) return 10;
    if (count >= 140) return 9;
    if (count >= 101) return 8;
    if (count >= 80) return 7;
    if (count >= 66) return 6;
    if (count >= 45) return 5;
    return null;
  }

  function calculateFormation() {
    const inputEl = document.getElementById('studentCount');
    const resultEl = document.getElementById('result');
    if (!inputEl || !resultEl) return;

    const count = parseInt(inputEl.value);

    if (!count) {
      resultEl.innerText = 'Please enter a valid number';
      return;
    }

    if (count <= 8) {
      resultEl.innerHTML = `<span class="underline">All Standing</span>`;
      return;
    }

    if (predefinedFormations[count]) {
      const formation = predefinedFormations[count];
      resultEl.innerHTML =
        `<span class="underline">${formation.length} Rows</span>\n` +
        `Formation: ${formation.join(' - ')}`;
      return;
    }

    // Force 11 rows if over 194
    let rowCount;
    if (count > 194) {
      rowCount = 11;
    } else {
      rowCount = getRowCount(count);
    }

    if (!rowCount) {
      resultEl.innerText = 'Please enter a number between 9 and 161+';
      return;
    }

    let avg = count / rowCount;
    let avgDisplay = avg.toFixed(2);
    let high = Math.round(avg);
    let low = high - 1;
    let formation = [];

    for (let i = 0; i < rowCount; i++) {
      formation.push(i % 2 === 0 ? high : low);
    }

    let total = formation.reduce((a, b) => a + b, 0);
    let scanIns = count - total;

    while (scanIns < 0 && high > 1) {
      high--;
      low = high - 1;
      formation = [];
      for (let i = 0; i < rowCount; i++) {
        formation.push(i % 2 === 0 ? high : low);
      }
      total = formation.reduce((a, b) => a + b, 0);
      scanIns = count - total;
    }

    resultEl.innerHTML =
      `<span class="underline">${rowCount} Rows</span>\n` +
      `Formation: ${formation.join(' - ')}\n` +
      `Scan In(s): ${scanIns}\n` +
      `Average per row: ${avgDisplay}`;
  }

  // Scroll logic
  window.scrollTo(0, 0);
  let userManuallyScrolled = false;

  window.addEventListener('scroll', () => {
    userManuallyScrolled = true;
  });

  const scrollInterval = setInterval(() => {
    if (!userManuallyScrolled) {
      window.scrollTo(0, 0);
    } else {
      clearInterval(scrollInterval);
    }
  }, 100);

  const input = document.getElementById('studentCount');
  if (input) {
    input.addEventListener('focus', () => {
      userManuallyScrolled = true;
    });
    input.addEventListener('blur', () => {
      setTimeout(() => {
        window.scrollTo(0, 0);
        userManuallyScrolled = false;
      }, 100);
    });
  }
</script>
